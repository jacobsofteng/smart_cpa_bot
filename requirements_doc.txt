Цель
Запустить Telegram-бота-витрину, который:
* общается как «лояльный продавец»,
* мягко ведёт к заданиям (офферам). Не навязывает услуги, а даёт возможность заработать,
* трекает клики, собирает фидбек,
* начисляет баллы и позволяет создать заявку на выведение баллов, если их больше 700,
Модель взаимодействия
Бот-1: онбординг → диалог через LLM → подбор офферов → выдача уникальных ссылок на задания в Бот-2. В Бот-2 на конкретное сообщение с описанием оффера и внешней ссылкой CPA. Пользователь кликает CPA-ссылку из Бота-2, выполняет целевое действие → вы получаете постбек → начисляете бонусы.


1. Роли и объекты
* Клиент.

* Бот 1
* Бот 2

* CPA-сеть/партнёр (источник офферов, подтверждений).

* Админ.

* Хранилище данных + очереди задач.


2. Общение с пользователем
2.1 онбординг
   * Имя — обязательное.

   * Возраст — обязательное. Валидация: только целые цифры

      * < 18: доступна только категория «подработки 16+/17+» и «джуниор-карты/ офферы без возрастных рисков». Любые продукты 18+ скрыты.

      * 18–19: доступны офферы 18+, офферы с ограничением 20+ скрыты.

      * ≥ 20: доступны все офферы. (Проверять на максимальный возраст, тк есть продукты доступные только до 75)

         * Город — опционально. Используется для гео-таргета и расписаний локальных офферов.

         * Телефон — опционально. Используется для:

            * отправки сертификатов/чеков,

            * детерминации дубликатов,




2.2 UX-логика
               * Отбор на этапе онбординга. Показ только целевых офферов.
               * Если город/телефон пропущены, показывать офферы без гео-таргета 
2.3 общение с пользователем
Ты — вежливый ассистент для витрины заданий. Отвечай 1–2 короткими предложениями.
Не придумывай ссылки, суммы, баланс, статусы — этим занимается система.
Если разговор про задания/деньги, мягко предлагай «подберу задания с баллами».
Если smalltalk — поддержи коротко. Задавай не больше одного уточняющего вопроса.
Если пользователь просит баланс/начисления — скажи, что этим занимается раздел «Баланс», и дождись ответа системы.
Избегай императивов, не обещай результата, не оценивай кредитоспособность.
               * Стоп-темы. Агрессия/оскорбления/разжигание, политика, мошенничество, медицинские советы, сексуализированный контент, за исключением лёгкой эротики.

               * Действия бота.

                  * мягкая деэскалация (1–2 фразы),

                  * перевод к безопасному шаблону («не могу помочь с этим, но могу подсказать по заданиям и баллам»),

                  * при повторе — вежливое завершение ветки.

                     * Фильтры. Словарь стоп-слов + простые эвристики; при срабатывании — не вызывать LLM, отвечать шаблоном.

                     * Анти-спам. Ограничение частоты сообщений (мягкий rate-limit)

                     * Фрод-сигналы. Повторные «выполнил» без кликов, массовые клики по разным офферам за короткое время, совпадения tg_id/device/IP — помечать, не выдавать награды до проверки.

                     * Жалобы. Команда для пользователя «пожаловаться» → запись в feedback + уведомление админа.

                     * Логи модерации. Все срабатывания фильтров/блокировок — в admin_actions/audit_log с причиной и контекстом (замаскированным). 



2.4 Контекст, который передаём в модель
                        * Профиль: имя/возраст/город (если есть).

                        * Превью офферов (не больше 2–3): «МФО А ~150 баллов; МФО Б ~200 баллов».

                        * Запоминаем последние n сообщений диалога. (обсудить более подробно)

                        * Язык — авто (русский по умолчанию).

2.4 Забороны (жёсткие)
                           * НЕЛЬЗЯ: генерировать ссылки, суммы, баланс, коды сертификатов, статусы заявок.

                           * НЕЛЬЗЯ: длинные абзацы, списки, лекции, Emoji-спам.

2.5 Поведенческие принципы (повтор)
                              * Тон: дружелюбный, спокойный, не навязывает, «как заботливый продавец».

                              * Формат: 1–2 предложения; максимум 1 вопрос в конце.

                              * Если пользователь уходит в оффтоп → коротко поддержать и плавно вернуть к помощи с заданиями.

                              * Имя пользователя (если есть) вставлять мягким префиксом: «Иван, …» через каждые 5-7 сообщений.
                              * При показе ссылок на офферы, писать текущий баланс бонусов.
3. Клик → выполнение → возврат
3.1 Переход
                                 * Кнопка/ссылка с метками click_id, user_id, offer_id, ts.

                                 * Регистрация клика сервером до редиректа.

3.2 Возврат
                                    * Клиент вручную сообщает: «выполнил/не выполнил», опционально фидбек и готовность повторять.

                                    * Сразу после фиксации ответа — ставится «ожидание подтверждения CPA» по событию conversion_pending с датой ts_click.
3.3 Отложенный фоллоу-ап
                                       * Через 10 минут после отправки задания — одно уточнение прогресса.

                                       * Не отправлять, если уже зафиксирован любой из статусов: completed_self_reported, not_completed, clicked_recently<10m.

При ответе «нужна помощь» — показать мини-FAQ по офферу и шагам.

3.4 Подтверждение от CPA
                                          * Источники: пост-бек вебхук, поллинг API, ручной импорт.

                                          * Статусы конверсии: pending → approved | rejected | hold.

                                          * На approved:

                                             * Создать проводку в леджере бонусов: credit с суммой «к выплате»

                                             * Обновить «ожидаемые» → «доступные».

                                                * На rejected — объяснение причины (если пришла), автоматическая рекомендация по ретро, если допустимо.

                                                * На hold — отобразить причину, если доступна (в бд).


4. Баланс и награды
4.1 Модели сумм
                                                   * available_balance — доступно к выводу.

                                                   * pending_balance — ожидает подтверждения CPA.

                                                   * locked_balance — временно удержано (споры/чарджбеки).

                                                   * История операций — неизменяемый леджер.


4.2 Начисление бонусов
                                                      * Написать текст уведомления
                                                      * Для внутреннего использования:: «Начисление проходит проверку и появится в течение N+5 дней после подтверждения.» N - дни до выплаты от CPA к нам. N+5 — наш буфер на пост-бек + финальные reconciliation-процедуры. Отображать дату ETA = date_cpa_confirm + N + 5.
4.3 Реферальная программа
                                                      * Вознаграждение за друга: фикс 200 бонусов после того, как друг выполнил 1 задание и пришёл расчёт от CPA.
Дополнительно 20% от суммы бонусов друга за первые 3 задания (отправляются на счет после получения апрува 3го задания).
                                                      * Пользователь может отправить свою реферальную ссылку друзьям (она уникальна для каждого пользователя)
                                                      * Клиенту после завершения онбординга генерируется рандомная ссылка, для того, чтобы он мог зарефералить друга. Данная реферальная ссылка записывается в бд. 
                                                      * После того как ссылка создалась, клиенту отправляется сообщение: “Пригласи друга и получи 200 бонусов после его первого задания, а также  20% от суммы бонусов за первые три задания. Суммарно за 1 друга можно получить до 2500 бонусов, всё зависит только от тебя и как сильно ты замотивируешь его выполнять задания! Количество приглашений неограниченно! 
Все бонусы конвертируются в сертификаты золотого яблока, озона или Вб
Ссылки для быстрой отправки:
https://t.me/your_bot?start=ref12345”


                                                         * Анти-фрод:

                                                            * запрет самореферала (нельзя самому себе отправить реферальную ссылку и по ней выполнять задания)

4.4 Вывод бонусов
4.4.1Вывод бонусов: 
                                                               1. Если клиент захотел вывести бонусы,он пишет триггерные слова, связанные с выводом бонусов (вывести бонусы и тд) далее идет проверка на количество бонусов, хватает ли бонусов чтобы вывести. Минимальное количество бонусов для вывода 700.
                                                               2. Если сумма бонусов у клиента больше 700 рублей, клиент может их вывести тремя способами: выбрать сертификат в золотое яблоко, вб или озон. 
                                                               3. После того, как пользователь выбрал тип сертификата, нужно выбрать сумму для вывода, она должна быть не больше текущего баланса, а также кратна номиналу или сумме сертификатов озон или вб, на сертификат золотого яблока правило кратности, не распространяется, можно выбрать любую сумму. Например: баланс клиента 1123 рубля и пользователь решил получить сертификат в озон на 1000 рублей. Пользователь соглашается на сертификат в 1000 рублей и 123 рубля остается на балансе, до следующих накопленных бонусов. 
                                                               4. После выбора типа и номинала, необходимо спросить номер и почту куда отправить сертификат, далее заявка падает в бд со статусом pending.
                                                               5. После того, как заявка попала в бд с таким статусом, оператор “ручками” самостоятельно её обрабатывает и меняет статус на новый: issued. 
                                                               6. После выдачи сертификата должны пересчитаться текущие бонусы и показывать клиенту их актуальное число. 
                                                               7. Необходимо сохранять всю историю бонусов клиентов. 
Номиналы сертификатов в золотое яблоко, озон и вб: 
1) Сертификат в золотое яблоко любая сумма от 700 рублей, 
2) Сертификат Ozon: от 500 рублей; номиналы: 700, 1000, 1500, 2000, 3000, 3500, 4000, 5000, 8000, 10000.

3) Сертификат WB: от 500 рублей; номиналы: 1000, 2000, 3000, 5000, 8000, 10000.


4.4.2 Процесс
                                                               1. Пользователь инициирует вывод → бот показывает допустимые методы и суммы на базе available_balance.

                                                               2. Пользователь выбирает метод и сумму/номинал.

                                                               3. Сервер валидирует: баланс достаточен; метод допустим. Сумма вывода должна соответствовать порогу/номиналу метода и не превышать available_balance.

                                                               4. Запрос контактных данных для доставки сертификата/кода: телефон и e-mail. Валидация формата, подтверждение владения по коду, если ранее не подтверждал.

                                                               5. Создать заявку payout_request со статусом pending.

                                                               6. После выдачи:

                                                                  * Обновить статус на issued.

                                                                  * Списать сумму из available_balance леджером debit.

4.5 Лидерборд
                                                                     * Ежедневный пересчёт 01:00 локального сервера.

                                                                     * Псевдонимизация: имя

                                                                     * Метрики: сумма за последний день, количество выполненных заданий, приглашенных друзей, количество баллов.
Пример: 
1 место. Андрей 2700 баллов (6 заданий, 3 друга)
2 место. Иван 2700 баллов (6 заданий, 3 друга)
3 место. Анна 2700 баллов (6 заданий, 3 друга)
4 место. Петя 2700 баллов (6 заданий, 3 друга)
5 место. Сергей 2700 баллов (6 заданий, 3 друга)
.
.
.
170 место. Имя пользователя N баллов ( N-заданий, N друзей)




5 Нефункциональные требования
                                                                        * 100+ параллельных диалогов, задержка ответа < 2 с при офферах/балансе; LLM ≤ 5–8 с.

                                                                        * Бюджет MVP: ≤ $200 и 1 месяц.

                                                                        * Логи ошибок и бизнес-событий (клик, approve, redeem).

                                                                        * Конфиги через .env.

                                                                        * Безопасность: токены и ключи — не в коде; проверка ADMINS на админ-командах.

6. Дополнительно. Основные таблицы (логическая схема, без кода)
                                                                           * users(id, name, age, city, phone, email, consents, status, created_at, updated_at)

                                                                           * offers(id, title, category, min_age, geo, payout_brutto, eCPA, max_frequency_days, active, partner_id)

                                                                           * clicks(id, user_id, offer_id, click_id, ts, source_slot)

                                                                           * conversions(id, user_id, offer_id, click_id, status, amount_netto, raw_payload, ts_created, ts_updated, eta_date)

                                                                           * balances_ledger(id, user_id, type[credit|debit|lock|unlock|adjust], amount, currency, reference_type, reference_id, ts, notes)

                                                                           * payout_requests(id, user_id, method[direct|ozon|wb], amount, denomination, phone, email, status[pending|approved_internal|issued|failed], ts_created, ts_updated, payload)

                                                                           * referrals(id, referrer_user_id, referee_user_id, code, ts_joined, first_touch_ts, status[attributed|qualified|rewarded], reward_fixed, reward_percent_amount)

                                                                           * leaderboard_snapshots(id, date, payload, generated_at)

                                                                           * feedback(id, user_id, offer_id, rating[1–5], comment, ready_to_repeat[bool], ts)

                                                                           * admin_actions(id, admin_id, action, target_table, target_id, delta, reason, ts)

                                                                           * audit_log(id, actor, action, entity, entity_id, before, after, ts)