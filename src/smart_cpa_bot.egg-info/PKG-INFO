Metadata-Version: 2.4
Name: smart-cpa-bot
Version: 0.1.0
Summary: Dual Telegram bot system for CPA offer onboarding and offer delivery
Author: Smart CPA
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: aiogram>=3.4.1
Requires-Dist: fastapi>=0.110
Requires-Dist: uvicorn[standard]>=0.29
Requires-Dist: httpx>=0.27
Requires-Dist: sqlalchemy[asyncio]>=2.0
Requires-Dist: aiosqlite>=0.19
Requires-Dist: pydantic>=2.6
Requires-Dist: pydantic-settings>=2.2
Requires-Dist: python-dotenv>=1.0
Requires-Dist: cachetools>=5.3
Requires-Dist: tenacity>=8.2
Requires-Dist: shortuuid>=1.0
Requires-Dist: babel>=2.14
Provides-Extra: dev
Requires-Dist: pytest>=8.1; extra == "dev"
Requires-Dist: pytest-asyncio>=0.23; extra == "dev"
Requires-Dist: anyio>=4.2; extra == "dev"

# Smart CPA bot

Dual Telegram-bot setup for onboarding users via LLM and delivering CPA offers sourced from Saleads.

## Features

- Bot 1: onboarding, profile validation, LLM-driven dialog, referral handling, balance summary, payout flow entrypoint.
- Bot 2: renders recommended offers, tracks clicks via the local API redirector, captures user feedback/self-reports.
- FastAPI backend: Saleads postback webhook, click redirector (`/r/{token}`), leaderboard endpoint.
- SQLite (async SQLAlchemy) schema mirroring the requirements (users, offers, clicks, conversions, ledger, payouts, feedback, referrals, leaderboard).
- Queue-friendly services for Saleads sync, conversions, payouts, recommendations, and LLM guardrails.

## Project layout

```
.
├── src/smart_cpa_bot/
│   ├── api/               # FastAPI app (webhooks, redirects, leaderboard)
│   ├── models/            # SQLAlchemy models & mixins
│   ├── services/          # Business services (Saleads, offers, ledger, LLM, payouts, etc.)
│   ├── telegram/
│   │   ├── middlewares.py # Async DB session middleware
│   │   └── routers/       # aiogram routers for the two bots
│   └── scripts/           # CLI entrypoints to run bots/API locally
├── api_docs.html          # Saved Saleads documentation
├── requirements_doc.txt   # Functional specification exported from Google Docs
└── tests/                 # (placeholder for pytest-based tests)
```

## Prerequisites

- Python >= 3.11
- SQLite (already bundled) or alternative DB supported by SQLAlchemy asyncio driver
- Saleads API token, Telegram tokens for both bots, Ollama running locally with `gpt-oss-20b`

## Setup

1. Create and activate a virtualenv, then install dependencies:

   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -e .
   ```

2. Copy `.env.example` to `.env` and fill in:

   - `PRIMARY_BOT__TOKEN` / `PRIMARY_BOT__NAME`
   - `OFFERS_BOT__TOKEN` / `OFFERS_BOT__NAME`
   - `SALEADS__TOKEN` (+ optional `SALEADS__DEFAULT_STAND_UUID`)
   - `LLM__ENDPOINT` / `LLM__MODEL` (defaults point to local Ollama)
   - `WEBHOOK_SECRET` used both by Saleads postback and admin payout endpoints

3. Initialize the database (tables auto-create on the first FastAPI start, or run the snippet below):

   ```bash
   python - <<'PY'
   import asyncio
   from smart_cpa_bot.db import _engine
   from smart_cpa_bot.models import Base
   async def main():
       async with _engine.begin() as conn:
           await conn.run_sync(Base.metadata.create_all)
   asyncio.run(main())
   PY
   ```

## Running locally

Terminal 1 – API + redirector:

```bash
python -m smart_cpa_bot.scripts.run_api
```

Terminal 2 – onboarding bot (LLM + balances + payouts):

```bash
python -m smart_cpa_bot.scripts.run_primary_bot
```

Terminal 3 – offer board bot:

```bash
python -m smart_cpa_bot.scripts.run_offers_bot
```

Saleads should point its postback to `POST /webhooks/saleads/postback` with header `X-Webhook-Secret: <WEBHOOK_SECRET>`. Click buttons in Bot 2 hit `GET /r/{token}` which logs the click and redirects to the partner URL.

## Testing

Basic pytest scaffolding is expected under `tests/`. After adding cases, run:

```bash
pytest
```

## Environmental notes

- Config uses nested env vars (e.g. `PRIMARY_BOT__TOKEN`) via `pydantic-settings`.
- Default SQLite path: `smart_cpa.db` in project root. Switch to Postgres by changing `DATABASE_URL`.
- The `public_base_url` setting controls how click tracking links are built (`https://<host>/r/{token}`).
